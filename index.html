<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>World of Sea Battle (Early Access) ‚Äî DPS Comparator</title>
  <style>
    :root {
      --bg: #0b1220; --panel: #121b2e; --muted: #8aa0c7; --text: #e9f0ff;
      --accent: #5aa2ff; --accent-2: #9bffd1; --chip: #1a2540; --border: #21304a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#000;color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    h1{font-weight:800;letter-spacing:.3px;margin:0 0 16px;font-size:28px}
    .subtitle{color:var(--muted);margin-bottom:22px}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.02)}
    .row{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
    .group{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:var(--chip);border-radius:12px;border:1px solid var(--border)}
    .group-title{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-right:8px}

    .btn{cursor:pointer;user-select:none;border:1px solid var(--border);background:linear-gradient(180deg,#17243f,#15223b);color:var(--text);padding:8px 12px;border-radius:10px;font-weight:600;transition:transform .06s ease,background .2s ease,border-color .2s ease,box-shadow .2s ease;position:relative}
    .btn:hover{transform:translateY(-1px);border-color:#2b416a}
    .btn.active{background:linear-gradient(180deg,#1b7cff,#0f5ed1);border-color:#67a4ff;box-shadow:0 0 0 2px rgba(26,140,255,.25),0 6px 18px rgba(14,97,255,.25);color:#f4f9ff}
    .btn.active::after{content:"";position:absolute;inset:auto 8px -6px 8px;height:4px;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--accent-2));opacity:.9}

    .table-wrap{margin-top:16px;overflow-x:auto;border-radius:14px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;min-width:880px}
    thead th{position:sticky;top:0;background:#17223b;color:#cfe0ff;text-align:left;font-size:12px;letter-spacing:.4px;text-transform:uppercase;padding:12px;border-bottom:1px solid var(--border)}
    tbody td{padding:12px;border-bottom:1px dashed #1e2b45}
    tbody tr:hover{background:rgba(90,162,255,.08)}
    .num{text-align:right;font-variant-numeric:tabular-nums}

    .note{color:var(--muted);font-size:13px;margin-top:10px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a304f;border:1px solid #27476f;color:#cfe0ff;font-size:12px}
    .footer{color:var(--muted);font-size:12px;margin-top:16px}

    /* Winner / Runner-up */
    tbody tr.winner{background:radial-gradient(1200px 120px at 10% 0%,rgba(155,255,209,.10),transparent),rgba(14,26,49,.6);outline:2px solid var(--accent-2);box-shadow:0 0 0 2px rgba(155,255,209,.25) inset,0 12px 28px rgba(0,0,0,.35)}
    tbody tr.runnerup{background:radial-gradient(1200px 120px at 10% 0%,rgba(210,218,230,.10),transparent),rgba(14,18,32,.55);outline:2px solid #b6c3d8;box-shadow:0 0 0 2px rgba(182,195,216,.18) inset,0 10px 22px rgba(0,0,0,.28)}
    .winner-badge,.runner-badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;margin-left:8px;border-radius:999px;font-size:12px;font-weight:700}
    .winner-badge{background:linear-gradient(180deg,#1d3b2f,#184b3b);border:1px solid #3eb98d;color:#c8ffe8}
    .runner-badge{background:linear-gradient(180deg,#262b34,#2e3644);border:1px solid #9fb2cc;color:#e7eef9}
    .emoji.silver-cup{filter:grayscale(1) brightness(1.2)}

    /* Deciding column visuals */
    .decide{position:relative}
    .sort-pill{display:inline-flex;align-items:center;gap:6px;margin-left:8px;padding:2px 8px;border-radius:999px;background:linear-gradient(180deg,#1a2b4b,#14233f);border:1px solid #33507d;color:#d4e6ff;font-size:11px;letter-spacing:.2px}
    .sort-pill:before{content:"‚¨á"}
    .meter{position:relative;display:inline-block;min-width:150px;padding-left:8px}
    .meter-bar{position:relative;height:10px;border-radius:999px;background:#14223b;border:1px solid #2b3e63;overflow:hidden}
    .meter-fill{height:100%;background:linear-gradient(90deg,#4ee3a3,#2fb6ff);box-shadow:0 0 12px rgba(79,226,164,.35) inset}
    .meter-val{display:block;text-align:right;font-variant-numeric:tabular-nums;margin-top:6px;font-weight:700}

    /* Sparkline */
    .mini{width:220px}
    .mini svg{width:100%;height:34px;display:block}
    .mini .axis{stroke:#2a3c60;stroke-width:1}
    .mini .line{fill:none;stroke:#9bffd1;stroke-width:2;filter:drop-shadow(0 1px 0 rgba(0,0,0,.4))}
    .mini .area{fill:rgba(155,255,209,.12)}

    /* Damage Graph */
    #damageGraph svg { display: block; }
    .graph-axis { stroke: #3a4f75; stroke-width: 1.5; }
    .graph-grid { stroke: #1e2d47; stroke-width: 1; stroke-dasharray: 2,2; }
    .graph-line { fill: none; stroke-width: 2.5; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); transition: stroke-width 0.2s; }
    .graph-line:hover { stroke-width: 3.5; }
    .graph-label { fill: var(--muted); font-size: 11px; font-family: Inter, ui-sans-serif, system-ui; }
    .graph-title { fill: var(--text); font-size: 12px; font-weight: 600; font-family: Inter, ui-sans-serif, system-ui; }
    .graph-legend { font-size: 11px; font-family: Inter, ui-sans-serif, system-ui; }
    .graph-legend-item { cursor: pointer; opacity: 1; transition: opacity 0.2s; }
    .graph-legend-item.hidden { opacity: 0.3; }
  /* First column wider + no wrap to keep badges on one line */
    table th:first-child, table td:first-child { min-width: 320px; white-space: nowrap; }
  .explain { margin-top: 40px; background: rgba(18,27,46,.7); border: 1px solid var(--border); border-radius: 14px; padding: 0; box-shadow: 0 8px 20px rgba(0,0,0,.25); overflow: hidden; }
    .explain summary { cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: #0d1730; color: #cfe0ff; border-bottom: 1px solid #1a2746; font-weight: 700; }
    .explain summary::-webkit-details-marker { display: none; }
    .explain .caret { width: 10px; height: 10px; border: 2px solid #6b8dc7; border-top: 0; border-left: 0; transform: rotate(45deg); transition: transform .2s ease; }
    .explain[open] .caret { transform: rotate(225deg); }
    .explain .body { padding: 16px; }
    .explain h2 { display: none; }
    .explain h3 { margin: 16px 0 6px; font-size: 15px; color: #d7e6ff; }
    .explain p, .explain li { color: #c3cdea; line-height: 1.55; }
    .explain h2 { margin: 0 0 8px; font-size: 20px; }
    .explain h3 { margin: 18px 0 6px; font-size: 16px; color: #d7e6ff; }
    .explain p, .explain li { color: #cfdaf3; line-height: 1.5; }
    .eq { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: #0f1a32; border: 1px solid #1f3050; padding: 6px 8px; border-radius: 8px; display: inline-block; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background: #16274a; border: 1px solid #2b416a; padding: 2px 6px; border-radius: 6px; }
  /* Hierarchy tweaks for stronger table focus */
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02); }
    .table-wrap { margin-top: 16px; overflow-x: auto; border-radius: 14px; border: 1px solid var(--border); }

    /* Collapsible explanation styles */
    .explain { margin-top: 40px; background: #0e1526; border: 1px solid #1a2a46; border-radius: 14px; padding: 0; box-shadow: 0 8px 20px rgba(0,0,0,.25); overflow: hidden; }
    .explain summary { cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: #0f1a32; color: #d9e6ff; border-bottom: 1px solid #182746; font-weight: 700; }
    .explain summary::-webkit-details-marker { display: none; }
    .explain .caret { width: 10px; height: 10px; border: 2px solid #7fa4e8; border-top: 0; border-left: 0; transform: rotate(45deg); transition: transform .2s ease; }
    .explain[open] .caret { transform: rotate(225deg); }
    .explain .body { padding: 16px; }
    .explain h2 { display: none; }
    .explain h3 { margin: 16px 0 6px; font-size: 15px; color: #d7e6ff; }
    .explain p, .explain li { color: #c3cdea; line-height: 1.55; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>World of Sea Battle (Early Access) - DPS Comparator v1.3</h1>
    <div class="subtitle">Compare cannon damage over a 60‚Äësecond window. Formula: <span class="badge">damage = max(0, penetration ‚àí armor)</span>, shots/60s = <span class="badge">60 √∑ reload</span>.</div>

    <div class="panel">
      <div class="row">
        <div class="group" id="shipGroup" role="group" aria-label="Ship selector">
          <div class="group-title">Ship</div>
        </div>
        <div class="group" id="sizeGroup" role="group" aria-label="Cannon size selector">
          <div class="group-title">Cannon Size</div>
          <button class="btn active" data-size="Light" aria-pressed="true">Light</button>
          <button class="btn" data-size="Medium" aria-pressed="false">Medium</button>
          <button class="btn" data-size="Heavy" aria-pressed="false">Heavy</button>
        </div>
        <div class="group" id="armorGroup" role="group" aria-label="Armor selector">
          <div class="group-title">Target Armor</div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="resultTable" aria-live="polite">
          <thead><tr id="theadRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="note">The table updates instantly when you change <em>Ship</em>, <em>Cannon Size</em>, or <em>Target Armor</em>. Rows are sorted by the right‚Äëmost column.</div>
    </div>

    <div class="panel" style="margin-top: 20px;">
      <h3 style="margin: 0 0 16px; font-size: 18px; color: var(--text);">‚öîÔ∏è PvP Front-Load Damage Analysis</h3>
      <div class="subtitle" style="margin-bottom: 16px; color: var(--muted);">Compare cumulative damage over time (0-60s) to see which cannons deliver the fastest burst damage.</div>
      
      <div class="row">
        <div class="group" id="pvpShipGroup" role="group" aria-label="PvP Ship selector">
          <div class="group-title">Ship</div>
        </div>
        <div class="group" id="pvpSizeGroup" role="group" aria-label="PvP Cannon size selector">
          <div class="group-title">Cannon Size</div>
          <button class="btn active" data-pvp-size="Light" aria-pressed="true">Light</button>
          <button class="btn" data-pvp-size="Medium" aria-pressed="false">Medium</button>
          <button class="btn" data-pvp-size="Heavy" aria-pressed="false">Heavy</button>
        </div>
        <div class="group" id="pvpArmorGroup" role="group" aria-label="PvP Armor selector">
          <div class="group-title">Target Armor</div>
        </div>
      </div>

      <div id="pvpDamageGraph" style="width: 100%; height: 450px; background: var(--chip); border-radius: 12px; border: 1px solid var(--border); padding: 16px; margin-top: 16px;">
        <svg id="pvpGraphSvg" style="width: 100%; height: 100%;"></svg>
      </div>
      <div class="note" style="margin-top: 10px;">Shows cumulative damage accumulation from 0-60 seconds. Steeper curves indicate faster front-load damage, better for quick PvP engagements.</div>
    </div>

    <details class="explain" aria-labelledby="math-title">
      <summary><span class="caret"></span> üìò How the numbers are calculated (click to expand)</summary>
      <div class="body">
        <h2 id="math-title">How the numbers are calculated</h2>
        <p>This tool compares cannons by their expected damage output over a fixed 60‚Äësecond window. It assumes every shot hits and there are no crits or damage falloff.</p>

        <h3>1) Damage per shot</h3>
        <p>The base damage is penetration minus armor, never below zero:</p>
        <p class="eq">damage_per_shot = max(0, penetration ‚àí armor)</p>

        <h3>2) Shots per 60 seconds</h3>
        <p>We include fractional last shots, exactly matching your rule (e.g., 6 s left on a 12 s reload counts as <span class="kbd">0.5</span> shot):</p>
        <p class="eq">shots_in_60s = 60 √∑ reload_time_seconds</p>

        <h3>3) Damage over 60 seconds (deciding column)</h3>
        <p>This is the key comparison metric and the table is sorted by it:</p>
        <p class="eq">damage_in_60s = damage_per_shot √ó shots_in_60s</p>
        <p>Equivalently, the per‚Äësecond rate is <span class="eq">DPS = (penetration ‚àí armor) √∑ reload_time</span>, and <span class="eq">damage_in_60s = DPS √ó 60</span>.</p>

        <h3>4) Examples</h3>
        <ul>
          <li><strong>8‚Äëpdr cannon vs armor 7</strong>: penetration = 14, reload = 9 s.<br>
            <span class="eq">damage_per_shot = 14 ‚àí 7 = 7</span>,
            <span class="eq">shots_in_60s = 60/9 = 6.6667</span>,
            <span class="eq">damage_in_60s = 7 √ó 6.6667 = 46.67</span>.
          </li>
          <li><strong>6‚Äëpdr rusty vs armor 2</strong>: penetration = 13, reload = 10.5 s.<br>
            <span class="eq">damage_per_shot = 13 ‚àí 2 = 11</span>,
            <span class="eq">shots_in_60s = 60/10.5 = 5.7143</span>,
            <span class="eq">damage_in_60s = 11 √ó 5.7143 = 62.86</span>.
          </li>
        </ul>

        <h3>5) Modes and what they show</h3>
        <ul>
          <li><strong>Numeric armor (2‚Äì15)</strong>: computes the exact minute‚Äëdamage at the chosen armor. Winner/runner‚Äëup are crowned for this single armor value.</li>
          <li><strong>Small Ships</strong> (armor 2‚Äì5): aggregates performance across four armor values (2,3,4,5). It shows a sparkline, total wins, and the average minute‚Äëdamage (deciding column).</li>
          <li><strong>Medium Ships</strong> (armor 6‚Äì10): aggregates performance across five armor values (6,7,8,9,10). It shows a sparkline, total wins, and the average minute‚Äëdamage (deciding column).</li>
          <li><strong>Heavy Ships</strong> (armor 11‚Äì15): aggregates performance across five armor values (11,12,13,14,15). It shows a sparkline, total wins, and the average minute‚Äëdamage (deciding column).</li>
          <li><strong>All‚ÄëAround</strong> (armor 2‚Äì15): like Small Ships, but averaged across 2‚Ä¶15. The table is sorted by that average.</li>
        </ul>

        <h3>6) Tie handling & decimals</h3>
        <ul>
          <li><strong>Wins</strong> counts ties as full wins for all tied cannons (can switch to half‚Äëwins on request).</li>
          <li>All calcs keep full precision; the table displays 2 decimals (or 4 for Shots/60s).</li>
        </ul>

        <h3>7) Assumptions & limits</h3>
        <ul>
          <li>No misses, crits, overheating, or ammo limits; reloads are constant.</li>
          <li>Damage is linear with penetration minus armor; negatives clamp to zero.</li>
          <li>Window is 60 s; changing it scales results proportionally.</li>
        </ul>
      </div>
    </details>

    <div class="footer">Tip: faster reload shines at low armor; at higher armor, bigger penetration can catch up.</div>
  </div>

  <script>
    // === Data ================================================================
    const DATA = {
      Light: [
        { name: '6-pdr rusty', penetration: 13, reload: 10.5, boarding: 11 },
        { name: '6-pdr culverin', penetration: 14, reload: 15.5, boarding: 12 },
        { name: '12-pdr carronade', penetration: 20, reload: 22, boarding: 18 },
        { name: '8-pdr cannon', penetration: 14, reload: 9, boarding: 12 },
        { name: '8-pdr culverin', penetration: 15, reload: 13, boarding: 13 },
        { name: '16-pdr carronade', penetration: 21.5, reload: 19.5, boarding: 19 },
      ],
      Medium: [
        { name: '16-pdr cannon', penetration: 14, reload: 12, boarding: 12 },
        { name: '16-pdr culverin', penetration: 15, reload: 17.5, boarding: 13 },
        { name: '24-pdr carronade', penetration: 21.5, reload: 25.5, boarding: 19 },
        { name: '18-pdr cannon', penetration: 15, reload: 10.5, boarding: 13 },
        { name: '18-pdr long cannon', penetration: 16, reload: 15, boarding: 14 },
        { name: '28-pdr carronade', penetration: 23, reload: 22.5, boarding: 21 },
        { name: '20-pdr admiral', penetration: 17, reload: 13.5, boarding: 15 },
        { name: '22-pdr Scorcher', penetration: 19, reload: 26, boarding: 17 },
        { name: '32-pdr Stormbringer', penetration: 25.5, reload: 27.5, boarding: 23 },
      ],
      Heavy: [
        { name: '32-pdr cannon', penetration: 17.5, reload: 12, boarding: 0 },
        { name: '32-pdr long cannon', penetration: 18.5, reload: 17.5, boarding: 0 },
        { name: '42-pdr carronade', penetration: 27, reload: 26, boarding: 0 },
        { name: '36-pdr inrog', penetration: 20, reload: 16, boarding: 0 },
        { name: '38-pdr jericho', penetration: 22, reload: 30.5, boarding: 0 },
        { name: '48-pdr colossus', penetration: 30, reload: 32, boarding: 0 },
      ]
    };

    const SHIPS = {
      'Black Wind': { cannons: 16, sizes: ['Light'], class: 'Combat' },
      'Essex': { cannons: 21, sizes: ['Medium', 'Light'], class: 'Combat' },
      'Anson': { cannons: 30, sizes: ['Medium', 'Light'], class: 'Combat' },
      'Sans Pareil': { cannons: 38, sizes: ['Heavy', 'Medium', 'Light'], class: 'Combat' },
      'Victory': { cannons: 49, sizes: ['Heavy', 'Medium', 'Light'], class: 'Combat' },
      'San Martin': { cannons: 20, sizes: ['Light'], class: 'Heavy' },
      'Constitution': { cannons: 26, sizes: ['Medium', 'Light'], class: 'Heavy' },
      'Bellona': { cannons: 35, sizes: ['Medium', 'Light'], class: 'Heavy' },
      'Redoutable': { cannons: 43, sizes: ['Heavy', 'Medium', 'Light'], class: 'Heavy' },
      'Apostolov': { cannons: 59, sizes: ['Heavy', 'Medium', 'Light'], class: 'Heavy' }
    };

    // === State ===============================================================
    let state = { ship: '', size: 'Light', armor: 'small' }; // default Small Ships
    let pvpState = { ship: '', size: 'Light', armor: 5 }; // PvP section state (default armor 5 for medium ships)

    // === Utils ===============================================================
    const clamp0 = x => Math.max(0, x);
    const shotsPer60 = reload => 60 / reload; // fractional allowed
    const damagePerShot = (pen, armor) => clamp0(pen - armor);
    const damagePer60 = (pen, armor, reload) => damagePerShot(pen, armor) * shotsPer60(reload);
    const fmt = (n, d=2) => Number.isFinite(n) ? n.toFixed(d) : '-';

    // === Build Armor Buttons ================================================
    const armorGroup = document.getElementById('armorGroup');
    function buildArmorButtons(){
      armorGroup.querySelectorAll('button.btn, .line-break').forEach(b=>b.remove());
      
      // First line: Grouping buttons
      const smallBtn=document.createElement('button');
      smallBtn.className='btn'+(state.armor==='small'?' active':'');
      smallBtn.setAttribute('aria-pressed',state.armor==='small'?'true':'false');
      smallBtn.textContent='Small Ships';
      smallBtn.dataset.armor='small';
      armorGroup.appendChild(smallBtn);

      const mediumBtn=document.createElement('button');
      mediumBtn.className='btn'+(state.armor==='medium'?' active':'');
      mediumBtn.setAttribute('aria-pressed',state.armor==='medium'?'true':'false');
      mediumBtn.textContent='Medium Ships';
      mediumBtn.dataset.armor='medium';
      armorGroup.appendChild(mediumBtn);

      const heavyBtn=document.createElement('button');
      heavyBtn.className='btn'+(state.armor==='heavy'?' active':'');
      heavyBtn.setAttribute('aria-pressed',state.armor==='heavy'?'true':'false');
      heavyBtn.textContent='Heavy Ships';
      heavyBtn.dataset.armor='heavy';
      armorGroup.appendChild(heavyBtn);

      const allBtn=document.createElement('button');
      allBtn.className='btn'+(state.armor==='all'?' active':'');
      allBtn.setAttribute('aria-pressed',state.armor==='all'?'true':'false');
      allBtn.textContent='All‚ÄëAround';
      allBtn.dataset.armor='all';
      armorGroup.appendChild(allBtn);

      // Line break to force numbers to next line
      const lineBreak=document.createElement('div');
      lineBreak.className='line-break';
      lineBreak.style.width='100%';
      lineBreak.style.flexBasis='100%';
      armorGroup.appendChild(lineBreak);

      // Second line: Number buttons
      for(let a=2;a<=15;a++){
        const b=document.createElement('button');
        const isActive=a===state.armor;
        b.className='btn'+(isActive?' active':'');
        b.setAttribute('aria-pressed',isActive?'true':'false');
        b.textContent=String(a);
        b.dataset.armor=String(a);
        armorGroup.appendChild(b);
      }
    }

    // === Build Ship Buttons ================================================
    const shipGroup = document.getElementById('shipGroup');
    function buildShipButtons(){
      shipGroup.querySelectorAll('button.btn, .line-break, .class-label').forEach(b=>b.remove());
      
      // "All Cannons" button
      const allCannonsBtn=document.createElement('button');
      allCannonsBtn.className='btn'+(state.ship===''?' active':'');
      allCannonsBtn.setAttribute('aria-pressed',state.ship===''?'true':'false');
      allCannonsBtn.textContent='All Cannons';
      allCannonsBtn.dataset.ship='';
      shipGroup.appendChild(allCannonsBtn);

      // Line break
      const lineBreak1=document.createElement('div');
      lineBreak1.className='line-break';
      lineBreak1.style.width='100%';
      lineBreak1.style.flexBasis='100%';
      shipGroup.appendChild(lineBreak1);

      // Combat class label
      const combatLabel=document.createElement('span');
      combatLabel.className='class-label';
      combatLabel.style.fontSize='12px';
      combatLabel.style.textTransform='uppercase';
      combatLabel.style.letterSpacing='1px';
      combatLabel.style.color='var(--muted)';
      combatLabel.style.marginRight='8px';
      combatLabel.textContent='Combat:';
      shipGroup.appendChild(combatLabel);

      // Combat class ships in order: Black Wind, Essex, Anson, Sans Pareil, Victory
      const combatShips=['Black Wind','Essex','Anson','Sans Pareil','Victory'];
      combatShips.forEach(shipName=>{
        const btn=document.createElement('button');
        const isActive=state.ship===shipName;
        btn.className='btn'+(isActive?' active':'');
        btn.setAttribute('aria-pressed',isActive?'true':'false');
        btn.textContent=shipName;
        btn.dataset.ship=shipName;
        shipGroup.appendChild(btn);
      });

      // Line break
      const lineBreak2=document.createElement('div');
      lineBreak2.className='line-break';
      lineBreak2.style.width='100%';
      lineBreak2.style.flexBasis='100%';
      shipGroup.appendChild(lineBreak2);

      // Heavy class label
      const heavyLabel=document.createElement('span');
      heavyLabel.className='class-label';
      heavyLabel.style.fontSize='12px';
      heavyLabel.style.textTransform='uppercase';
      heavyLabel.style.letterSpacing='1px';
      heavyLabel.style.color='var(--muted)';
      heavyLabel.style.marginRight='8px';
      heavyLabel.textContent='Heavy:';
      shipGroup.appendChild(heavyLabel);

      // Heavy class ships in order: San Martin, Constitution, Bellona, Redoutable, Apostolov
      const heavyShips=['San Martin','Constitution','Bellona','Redoutable','Apostolov'];
      heavyShips.forEach(shipName=>{
        const btn=document.createElement('button');
        const isActive=state.ship===shipName;
        btn.className='btn'+(isActive?' active':'');
        btn.setAttribute('aria-pressed',isActive?'true':'false');
        btn.textContent=shipName;
        btn.dataset.ship=shipName;
        shipGroup.appendChild(btn);
      });
    }

    // === Build PvP Ship Buttons ============================================
    const pvpShipGroup = document.getElementById('pvpShipGroup');
    function buildPvpShipButtons(){
      pvpShipGroup.querySelectorAll('button.btn, .line-break, .class-label').forEach(b=>b.remove());
      
      // "All Cannons" button
      const allCannonsBtn=document.createElement('button');
      allCannonsBtn.className='btn'+(pvpState.ship===''?' active':'');
      allCannonsBtn.setAttribute('aria-pressed',pvpState.ship===''?'true':'false');
      allCannonsBtn.textContent='All Cannons';
      allCannonsBtn.dataset.pvpShip='';
      allCannonsBtn.setAttribute('data-pvp-ship', '');
      pvpShipGroup.appendChild(allCannonsBtn);

      // Line break
      const lineBreak1=document.createElement('div');
      lineBreak1.className='line-break';
      lineBreak1.style.width='100%';
      lineBreak1.style.flexBasis='100%';
      pvpShipGroup.appendChild(lineBreak1);

      // Combat class label
      const combatLabel=document.createElement('span');
      combatLabel.className='class-label';
      combatLabel.style.fontSize='12px';
      combatLabel.style.textTransform='uppercase';
      combatLabel.style.letterSpacing='1px';
      combatLabel.style.color='var(--muted)';
      combatLabel.style.marginRight='8px';
      combatLabel.textContent='Combat:';
      pvpShipGroup.appendChild(combatLabel);

      // Combat class ships
      const combatShips=['Black Wind','Essex','Anson','Sans Pareil','Victory'];
      combatShips.forEach(shipName=>{
        const btn=document.createElement('button');
        const isActive=pvpState.ship===shipName;
        btn.className='btn'+(isActive?' active':'');
        btn.setAttribute('aria-pressed',isActive?'true':'false');
        btn.textContent=shipName;
        btn.dataset.pvpShip=shipName;
        btn.setAttribute('data-pvp-ship', shipName);
        pvpShipGroup.appendChild(btn);
      });

      // Line break
      const lineBreak2=document.createElement('div');
      lineBreak2.className='line-break';
      lineBreak2.style.width='100%';
      lineBreak2.style.flexBasis='100%';
      pvpShipGroup.appendChild(lineBreak2);

      // Heavy class label
      const heavyLabel=document.createElement('span');
      heavyLabel.className='class-label';
      heavyLabel.style.fontSize='12px';
      heavyLabel.style.textTransform='uppercase';
      heavyLabel.style.letterSpacing='1px';
      heavyLabel.style.color='var(--muted)';
      heavyLabel.style.marginRight='8px';
      heavyLabel.textContent='Heavy:';
      pvpShipGroup.appendChild(heavyLabel);

      // Heavy class ships
      const heavyShips=['San Martin','Constitution','Bellona','Redoutable','Apostolov'];
      heavyShips.forEach(shipName=>{
        const btn=document.createElement('button');
        const isActive=pvpState.ship===shipName;
        btn.className='btn'+(isActive?' active':'');
        btn.setAttribute('aria-pressed',isActive?'true':'false');
        btn.textContent=shipName;
        btn.dataset.pvpShip=shipName;
        btn.setAttribute('data-pvp-ship', shipName);
        pvpShipGroup.appendChild(btn);
      });
    }

    // === Build PvP Armor Buttons ============================================
    const pvpArmorGroup = document.getElementById('pvpArmorGroup');
    function buildPvpArmorButtons(){
      pvpArmorGroup.querySelectorAll('button.btn').forEach(b=>b.remove());
      
      // Create buttons for armor values 2-15
      for(let a=2;a<=15;a++){
        const b=document.createElement('button');
        const isActive=a===pvpState.armor;
        b.className='btn'+(isActive?' active':'');
        b.setAttribute('aria-pressed',isActive?'true':'false');
        b.textContent=String(a);
        b.dataset.pvpArmor=String(a);
        b.setAttribute('data-pvp-armor', String(a));
        pvpArmorGroup.appendChild(b);
      }
    }

    // === Event Delegation for Groups ========================================
    function wireExclusiveGroup(el, dataAttr, onChange){
      el.addEventListener('click',e=>{
        const btn=e.target.closest('.btn');
        if(!btn||!el.contains(btn))return;
        const val=btn.dataset[dataAttr];
        if(val==null)return;
        el.querySelectorAll('.btn').forEach(x=>{x.classList.remove('active');x.setAttribute('aria-pressed','false');});
        btn.classList.add('active');
        btn.setAttribute('aria-pressed','true');
        onChange(val);
      });
    }

    wireExclusiveGroup(document.getElementById('sizeGroup'),'size',val=>{ 
      if(!state.ship || (state.ship && SHIPS[state.ship].sizes.includes(val))) { // Allow size change if no ship selected or if size is allowed for selected ship
        state.size=val; 
        renderTable(); 
      }
    });
    wireExclusiveGroup(armorGroup,'armor',val=>{
      if(val==='all') state.armor='all'; 
      else if(val==='small') state.armor='small';
      else if(val==='medium') state.armor='medium';
      else if(val==='heavy') state.armor='heavy';
      else state.armor=parseInt(val,10);
      renderTable();
    });
    wireExclusiveGroup(document.getElementById('shipGroup'),'ship',val=>{
      state.ship=val;
      if(val){
        // Ship selected: set size to first allowed size if current size not allowed, default to small armor
        const allowedSizes=SHIPS[val].sizes;
        if(!allowedSizes.includes(state.size)){
          state.size=allowedSizes[0];
        }
        if(typeof state.armor==='number' || state.armor==='all' || state.armor==='medium' || state.armor==='heavy'){
          state.armor='small';
        }
      }
      renderTable();
    });

    // PvP Section Event Handlers
    wireExclusiveGroup(document.getElementById('pvpSizeGroup'),'pvpSize',val=>{ 
      if(!pvpState.ship || (pvpState.ship && SHIPS[pvpState.ship].sizes.includes(val))) {
        pvpState.size=val; 
        renderPvpGraph(); 
      }
    });
    wireExclusiveGroup(pvpArmorGroup,'pvpArmor',val=>{
      pvpState.armor=parseInt(val,10);
      renderPvpGraph();
    });
    wireExclusiveGroup(pvpShipGroup,'pvpShip',val=>{
      pvpState.ship=val;
      if(val){
        const allowedSizes=SHIPS[val].sizes;
        if(!allowedSizes.includes(pvpState.size)){
          pvpState.size=allowedSizes[0];
        }
      }
      buildPvpShipButtons();
      renderPvpGraph();
    });

    // === Render Damage Graph ================================================
    // === Render ==============================================================
    function renderTable(){
      buildArmorButtons();
      buildShipButtons();
      // Update cannon size buttons based on ship selection
      const sizeGroup=document.getElementById('sizeGroup');
      sizeGroup.querySelectorAll('.btn').forEach(btn=>{
        const btnSize=btn.dataset.size;
        const isLocked=state.ship && !SHIPS[state.ship].sizes.includes(btnSize);
        if(isLocked){
          btn.classList.add('locked');
          btn.style.opacity='0.5';
          btn.style.cursor='not-allowed';
        }else{
          btn.classList.remove('locked');
          btn.style.opacity='';
          btn.style.cursor='';
        }
        const isActive=state.size===btnSize;
        btn.classList.toggle('active',isActive);
        btn.setAttribute('aria-pressed',isActive?'true':'false');
      });

      const tbody=document.querySelector('#resultTable tbody');
      const theadRow=document.getElementById('theadRow');
      tbody.innerHTML='';

      const shipMultiplier=state.ship?SHIPS[state.ship].cannons:1;
      const shipLabel=state.ship?`${state.ship} (${shipMultiplier} Cannons) ‚Äî `:'';

      // Aggregate modes
      if(state.armor==='all' || state.armor==='small' || state.armor==='medium' || state.armor==='heavy'){
        let armorStart, armorEnd;
        if(state.armor==='small'){ armorStart=2; armorEnd=5; }
        else if(state.armor==='medium'){ armorStart=6; armorEnd=10; }
        else if(state.armor==='heavy'){ armorStart=11; armorEnd=15; }
        else{ armorStart=2; armorEnd=15; } // all
        const armors=Array.from({length:armorEnd-armorStart+1},(_,i)=>armorStart+i);

        const dmgLabel=state.ship?'Avg Ship DPS / 60s':'Avg Dmg / 60s';
        theadRow.innerHTML=`
          <th style="min-width:320px;">Cannon</th>
          <th class="num">Penetration</th>
          <th class="num">Reload (s)</th>
          <th class="num">Boarding Dmg</th>
          <th class="mini">Dmg Curve ${armorStart}‚Üí${armorEnd}</th><th class="num">${shipLabel}${dmgLabel} (Armor ${armorStart}‚Äì${armorEnd}) <span class="sort-pill">sorted</span></th>`;

        const items=DATA[state.size].map(it=>({...it}));
        const dmgMatrix=items.map(it=>armors.map(a=>damagePer60(it.penetration,a,it.reload)*shipMultiplier));
        const bestPerArmor=armors.map((_,idx)=>Math.max(...dmgMatrix.map(row=>row[idx])));

        const rows=items.map((it,idx)=>{
          const arr=dmgMatrix[idx];
          const avg=arr.reduce((s,x)=>s+x,0)/arr.length;
          let wins=0; for(let i=0;i<arr.length;i++){ if(Math.abs(arr[i]-bestPerArmor[i])<1e-9) wins++; }
          const boardingTotal=it.boarding*shipMultiplier;
          return {name:it.name, pen:it.penetration, reload:it.reload, boarding:boardingTotal, avg, wins, arr};
        }).sort((a,b)=>b.avg-a.avg);

        const spark=(vals)=>{
          const w=200,h=28,max=Math.max(...vals)||1;
          const pts=vals.map((v,i)=>{const x=(i/(vals.length-1))*(w-2)+1; const y=h-(v/max)*(h-4)-2; return `${x.toFixed(1)},${y.toFixed(1)}`;}).join(' ');
          const area=`1,${h-2} ${pts} ${w-1},${h-2}`;
          return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><polyline class="axis" points="1,${h-2} ${w-1},${h-2}"></polyline><polygon class="area" points="${area}"></polygon><polyline class="line" points="${pts}"></polyline></svg>`;
        };

        const maxAvg=rows.length?rows[0].avg:1;
        const meterAvg=(val)=>{ const pct=Math.max(0,Math.min(100,(val/maxAvg)*100)); return `<div class="meter"><div class="meter-bar"><div class="meter-fill" style="width:${pct.toFixed(1)}%;"></div></div><span class="meter-val">${fmt(val,2)}</span></div>`; };

        rows.forEach((r,i)=>{
          const tr=document.createElement('tr');
          if(i===0) tr.classList.add('winner');
          if(i===1) tr.classList.add('runnerup');
          const nameCell=`${r.name}${i===0? ' <span class="winner-badge" title="Best all-around across armor '+armorStart+'‚Äì'+armorEnd+'"><span class="emoji">üåä</span> Best Winner</span>' : i===1? ' <span class="runner-badge" title="Second best all-around"><span class="emoji silver-cup">üèÜ</span> Second Best Winner</span>' : ''}`;
          const boardingDisplay=r.boarding===0?'TBD':fmt(r.boarding,0);
          tr.innerHTML=`
            <td>${nameCell}</td>
            <td class="num">${fmt(r.pen,2)}</td>
            <td class="num">${fmt(r.reload,2)}</td>
            <td class="num">${boardingDisplay}</td>
            <td class="mini">${spark(r.arr)}</td><td class="num decide">${meterAvg(r.avg)}</td>`;
          tbody.appendChild(tr);
        });
        return; // done
      }

      // Single-armor mode
      const dmgLabel=state.ship?'Ship DPS / 60s':'Damage / 60s';
      theadRow.innerHTML=`
        <th style="min-width:320px;">Cannon</th>
        <th class="num">Penetration</th>
        <th class="num">Reload (s)</th>
        <th class="num">Boarding Dmg</th>
        <th class="num">Shots / 60s</th>
        <th class="num">Damage / Shot</th>
        <th class="num">${shipLabel}${dmgLabel} <span class="sort-pill">sorted</span></th>`;

      const rows=DATA[state.size].map(it=>{
        const s60=shotsPer60(it.reload);
        const dpshot=damagePerShot(it.penetration,state.armor);
        const d60=dpshot*s60*shipMultiplier;
        const boardingTotal=it.boarding*shipMultiplier;
        return {name:it.name, pen:it.penetration, reload:it.reload, boarding:boardingTotal, s60, dpshot, d60};
      }).sort((a,b)=>b.d60-a.d60);

      const maxD=rows.length?rows[0].d60:1;
      const meter=(val)=>{ const pct=Math.max(0,Math.min(100,(val/maxD)*100)); return `<div class="meter"><div class="meter-bar"><div class="meter-fill" style="width:${pct.toFixed(1)}%;"></div></div><span class="meter-val">${fmt(val,2)}</span></div>`; };

      rows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        if(i===0) tr.classList.add('winner');
        if(i===1) tr.classList.add('runnerup');
        const nameCell=`${r.name}${i===0? ' <span class="winner-badge" title="Top damage in 60s"><span class="emoji">üèÜ</span> Best Winner</span>' : i===1? ' <span class="runner-badge" title="Second best in 60s"><span class="emoji silver-cup">üèÜ</span> Second Best Winner</span>' : ''}`;
        const boardingDisplay=r.boarding===0?'TBD':fmt(r.boarding,0);
        tr.innerHTML=`
          <td>${nameCell}</td>
          <td class="num">${fmt(r.pen,2)}</td>
          <td class="num">${fmt(r.reload,2)}</td>
          <td class="num">${boardingDisplay}</td>
          <td class="num">${fmt(r.s60,4)}</td>
          <td class="num">${fmt(r.dpshot,2)}</td>
          <td class="num decide">${meter(r.d60)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // === Update PvP Size Buttons ==========================================
    function updatePvpSizeButtons(){
      const pvpSizeGroup = document.getElementById('pvpSizeGroup');
      pvpSizeGroup.querySelectorAll('.btn').forEach(btn=>{
        const btnSize = btn.dataset.pvpSize;
        const isLocked = pvpState.ship && !SHIPS[pvpState.ship].sizes.includes(btnSize);
        if(isLocked){
          btn.classList.add('locked');
          btn.style.opacity='0.5';
          btn.style.cursor='not-allowed';
        }else{
          btn.classList.remove('locked');
          btn.style.opacity='';
          btn.style.cursor='';
        }
        const isActive = pvpState.size === btnSize;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive?'true':'false');
      });
    }

    // === Render PvP Front-Load Graph ======================================
    function renderPvpGraph(){
      updatePvpSizeButtons();
      const svg = document.getElementById('pvpGraphSvg');
      if(!svg) return;
      
      svg.innerHTML = '';
      
      // Get container dimensions
      const container = document.getElementById('pvpDamageGraph');
      const width = container ? container.clientWidth : 800;
      const height = 450;
      
      // Set SVG viewBox and dimensions
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);
      const margin = { top: 20, right: 140, bottom: 50, left: 70 };
      const graphWidth = width - margin.left - margin.right;
      const graphHeight = height - margin.top - margin.bottom;
      
      const cannons = DATA[pvpState.size] || [];
      const shipMultiplier = pvpState.ship ? SHIPS[pvpState.ship].cannons : 1;
      const armor = pvpState.armor;
      
      // Calculate cumulative damage over time for each cannon
      const timePoints = Array.from({length: 601}, (_, i) => i / 10); // 0 to 60 seconds, 0.1s increments
      const cannonData = cannons.map(cannon => {
        const dpshot = damagePerShot(cannon.penetration, armor);
        const cumulativeDamage = timePoints.map(time => {
          // Calculate how many shots have fired by this time
          // First shot fires at time 0, then subsequent shots at reload intervals
          // Formula: shotsFired = Math.floor(time / reload) + 1
          // At time 0: Math.floor(0/reload) + 1 = 0 + 1 = 1 shot
          // At time 9: Math.floor(9/9) + 1 = 1 + 1 = 2 shots
          // At time 18: Math.floor(18/9) + 1 = 2 + 1 = 3 shots
          const shotsFired = Math.floor(time / cannon.reload) + 1;
          
          // Calculate damage from shots fired
          let totalDamage = shotsFired * dpshot;
          // If ship selected, multiply by number of cannons
          if(pvpState.ship) {
            totalDamage *= shipMultiplier;
          }
          return totalDamage;
        });
        return {
          name: cannon.name,
          penetration: cannon.penetration,
          reload: cannon.reload,
          dpshot: dpshot,
          cumulativeDamage: cumulativeDamage
        };
      });
      
      // Find max damage for scaling
      const maxDamage = Math.max(...cannonData.flatMap(c => c.cumulativeDamage), 1);
      
      // Scale functions
      const xScale = (time) => margin.left + (time / 60) * graphWidth;
      const yScale = (damage) => margin.top + graphHeight - (damage / maxDamage) * graphHeight;
      
      // Create SVG group for clipping
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');
      clipPath.setAttribute('id', 'pvpGraphClip');
      const clipRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      clipRect.setAttribute('x', margin.left);
      clipRect.setAttribute('y', margin.top);
      clipRect.setAttribute('width', graphWidth);
      clipRect.setAttribute('height', graphHeight);
      clipPath.appendChild(clipRect);
      defs.appendChild(clipPath);
      svg.appendChild(defs);
      
      // Grid lines
      const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      gridGroup.setAttribute('class', 'grid-group');
      
      // Horizontal grid lines (damage)
      for(let i = 0; i <= 10; i++) {
        const y = margin.top + (i / 10) * graphHeight;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('class', 'graph-grid');
        line.setAttribute('x1', margin.left);
        line.setAttribute('y1', y);
        line.setAttribute('x2', width - margin.right);
        line.setAttribute('y2', y);
        gridGroup.appendChild(line);
      }
      
      // Vertical grid lines (time - every 10 seconds)
      for(let i = 0; i <= 6; i++) {
        const time = i * 10;
        const x = xScale(time);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('class', 'graph-grid');
        line.setAttribute('x1', x);
        line.setAttribute('y1', margin.top);
        line.setAttribute('x2', x);
        line.setAttribute('y2', height - margin.bottom);
        gridGroup.appendChild(line);
      }
      
      svg.appendChild(gridGroup);
      
      // Axes
      const axesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      axesGroup.setAttribute('class', 'axes-group');
      
      // X-axis (time)
      const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      xAxis.setAttribute('class', 'graph-axis');
      xAxis.setAttribute('x1', margin.left);
      xAxis.setAttribute('y1', height - margin.bottom);
      xAxis.setAttribute('x2', width - margin.right);
      xAxis.setAttribute('y2', height - margin.bottom);
      axesGroup.appendChild(xAxis);
      
      // Y-axis (damage)
      const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      yAxis.setAttribute('class', 'graph-axis');
      yAxis.setAttribute('x1', margin.left);
      yAxis.setAttribute('y1', margin.top);
      yAxis.setAttribute('x2', margin.left);
      yAxis.setAttribute('y2', height - margin.bottom);
      axesGroup.appendChild(yAxis);
      
      svg.appendChild(axesGroup);
      
      // Axis labels
      const labelsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      labelsGroup.setAttribute('class', 'labels-group');
      
      // X-axis labels (time - every 10 seconds)
      for(let i = 0; i <= 6; i++) {
        const time = i * 10;
        const x = xScale(time);
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'graph-label');
        text.setAttribute('x', x);
        text.setAttribute('y', height - margin.bottom + 20);
        text.setAttribute('text-anchor', 'middle');
        text.textContent = time + 's';
        labelsGroup.appendChild(text);
      }
      
      // Y-axis labels (damage values)
      for(let i = 0; i <= 10; i++) {
        const damage = (maxDamage / 10) * (10 - i);
        const y = margin.top + (i / 10) * graphHeight;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'graph-label');
        text.setAttribute('x', margin.left - 10);
        text.setAttribute('y', y + 4);
        text.setAttribute('text-anchor', 'end');
        text.textContent = fmt(damage, 0);
        labelsGroup.appendChild(text);
      }
      
      // Axis titles
      const xTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      xTitle.setAttribute('class', 'graph-title');
      xTitle.setAttribute('x', width / 2);
      xTitle.setAttribute('y', height - 10);
      xTitle.setAttribute('text-anchor', 'middle');
      xTitle.textContent = 'Time (seconds)';
      labelsGroup.appendChild(xTitle);
      
      const yTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      yTitle.setAttribute('class', 'graph-title');
      yTitle.setAttribute('x', 20);
      yTitle.setAttribute('y', height / 2);
      yTitle.setAttribute('text-anchor', 'middle');
      yTitle.setAttribute('transform', `rotate(-90, 20, ${height / 2})`);
      yTitle.textContent = pvpState.ship ? 'Cumulative Ship Damage' : 'Cumulative Damage';
      labelsGroup.appendChild(yTitle);
      
      svg.appendChild(labelsGroup);
      
      // Color palette for lines - 15 distinct colors for all cannons
      const colors = [
        '#5aa2ff', // Blue
        '#9bffd1', // Cyan
        '#ff9b5a', // Orange
        '#ff5a9b', // Pink
        '#9b5aff', // Purple
        '#5aff9b', // Green
        '#ffeb3b', // Yellow
        '#ff6b6b', // Red
        '#4ecdc4', // Teal
        '#95e1d3', // Mint
        '#f38181', // Coral
        '#aa96da', // Lavender
        '#fcbad3', // Light Pink
        '#ffffd2', // Cream
        '#a8e6cf'  // Seafoam
      ];
      
      // Draw step lines for each cannon (cumulative damage)
      const linesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      linesGroup.setAttribute('clip-path', 'url(#pvpGraphClip)');
      
      cannonData.forEach((cannon, idx) => {
        const color = colors[idx % colors.length];
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'graph-line');
        path.setAttribute('stroke', color);
        path.setAttribute('data-cannon', cannon.name);
        
        // Create step function path (cumulative damage increases at each shot)
        // First shot fires at time 0, so start at that damage value
        let pathData = '';
        const initialDamage = cannon.cumulativeDamage[0];
        pathData += `M ${xScale(0)} ${yScale(initialDamage)} `;
        
        // For each time point, draw horizontal line then step up when damage increases
        for(let i = 1; i < timePoints.length; i++) {
          const time = timePoints[i];
          const damage = cannon.cumulativeDamage[i];
          const prevDamage = cannon.cumulativeDamage[i-1];
          const x = xScale(time);
          const y = yScale(damage);
          
          if(damage > prevDamage) {
            // Damage increased (shot fired) - step up vertically first, then continue horizontally
            pathData += `L ${x} ${yScale(prevDamage)} L ${x} ${y} `;
          } else {
            // No change - continue horizontally
            pathData += `L ${x} ${y} `;
          }
        }
        
        path.setAttribute('d', pathData);
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        linesGroup.appendChild(path);
      });
      
      svg.appendChild(linesGroup);
      
      // Legend with final damage values at 60s
      const legendGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      legendGroup.setAttribute('class', 'legend-group');
      
      const legendX = width - margin.right + 10;
      let legendY = margin.top + 20;
      
      // Sort by final damage (60s) for legend
      const sortedCannons = [...cannonData].sort((a, b) => 
        b.cumulativeDamage[b.cumulativeDamage.length - 1] - 
        a.cumulativeDamage[a.cumulativeDamage.length - 1]
      );
      
      sortedCannons.forEach((cannon, idx) => {
        const originalIdx = cannonData.findIndex(c => c.name === cannon.name);
        const color = colors[originalIdx % colors.length];
        const finalDamage = cannon.cumulativeDamage[cannon.cumulativeDamage.length - 1];
        
        // Legend line
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', legendX);
        line.setAttribute('y1', legendY);
        line.setAttribute('x2', legendX + 20);
        line.setAttribute('y2', legendY);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', '2.5');
        line.setAttribute('data-cannon', cannon.name);
        legendGroup.appendChild(line);
        
        // Legend text with final damage
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'graph-legend');
        text.setAttribute('x', legendX + 25);
        text.setAttribute('y', legendY + 4);
        text.setAttribute('fill', 'var(--text)');
        text.setAttribute('data-cannon', cannon.name);
        text.textContent = `${cannon.name} (${fmt(finalDamage, 0)} @ 60s)`;
        legendGroup.appendChild(text);
        
        legendY += 18;
      });
      
      svg.appendChild(legendGroup);
    }

    // Init
    buildArmorButtons();
    buildShipButtons();
    buildPvpShipButtons();
    buildPvpArmorButtons();
    renderTable();
    renderPvpGraph();
  </script>
</body>
</html>
